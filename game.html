<!DOCTYPE html>
<html lang="en">
    <head>
        <title> Memory game </title>
        <meta charset="UTF-8">

        <link rel="stylesheet" type="text/css" href="styles/game.css">

    </head>

    <body>

        <div id="content">

            <div id="top_panel">

                <div id="mode_panel">
                    <h2>Choose game mode:</h2>
                    <button class="button_single" onclick="selectMode('single')">One player</button>
                    <button class="button_multi" onclick="selectMode('multi')">Two players</button>
                </div>  

                <div id="difficulty_panel">
                    <h2>Choose difficulty:</h2>
                    <button class="difficulty_1" onclick="selectDifficulty(1)">Easy</button>
                    <button class="difficulty_2" onclick="selectDifficulty(2)">Medium</button>
                    <button class="difficulty_3" onclick="selectDifficulty(3)">Hard</button>
                </div>  

            </div>

            <div id="current_player_panel">

                <h2>Ruch gracza: </h2>
                <div id="current_player_info"></div>

            </div>

            <div id="memory-board">

            </div>

            <div id="points_panel">

                <div class="points_content p1">
                    <p>Player 1</p>
                    <div id="p1_points">0</div>
                </div>

                <div class="points_content p2">
                    <p>Player 2</p>
                    <div id="p2_points">0</div>
                </div>

            </div>

        </div>

    </body>

    <script>

          let movesHistory = [];
          let allFound = [];
          const initialCards = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

          // Double the letters
          const cards = [...initialCards, ...initialCards];

          // Shuffle cards positions
          for (let i = cards.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [cards[i], cards[j]] = [cards[j], cards[i]];
          }

          let flippedCards = [];
          let flippedIndexes = [];

          let gameMode = '';
          let gameDifficulty = 0;

          let pointsP1 = 0;
          let pointsP2 = 0;

          let currentPlayer = 0;
    
          const memoryBoard = document.getElementById('memory-board');
          const modePanel = document.getElementById('mode_panel');
          const difficultyPanel = document.getElementById('difficulty_panel');
          const currentPlayerPanel = document.getElementById('current_player_panel');
          const pointsPanel = document.getElementById("points_panel");

          const pointsP1Element = document.getElementById("p1_points");
          const pointsP2Element = document.getElementById("p2_points");

          function selectMode(mode) {
            modePanel.style.display = "none";

            if (mode == 'single') {
                this.gameMode = 'single';
                difficultyPanel.style.display = "block";
                return;
            }

            if (mode == 'multi') {
                this.gameMode = 'multi';
                startGame();
                return;
            }

          }

          function selectDifficulty(difficulty) {
            this.gameDifficulty = difficulty;
            difficultyPanel.style.display = "none";
            startGame();
          }

          function updateCurrentPlayer() {
            document.getElementById("current_player_info").innerHTML = currentPlayer;
          }

          function updatePlayerPoints() {
            if (currentPlayer == "p1") {
                pointsP1+= 1;
                pointsP1Element.innerHTML = pointsP1;
            } else {
                pointsP2+= 1;
                pointsP2Element.innerHTML = pointsP2;
            }
          }

          function startGame() {
            if (this.gameMode == 'single')
                currentPlayer = 'p1';

            if (this.gameMode == 'multi')
                currentPlayer = Math.random() < 0.5 ? 'p1' : 'p2';

            currentPlayerPanel.style.display = "block";
            pointsPanel.style.display = "block";
            updateCurrentPlayer();

            createBoard();
          }

          function endGame() {
            if (document.querySelectorAll('.card[data-clicked="false"]').length === 0) {
              let wonPlayer = "DRAW";
              if (pointsP1 > pointsP2)
                wonPlayer = "Player 1";
              else if (pointsP2 > pointsP1)
                wonPlayer = "Player 2";

              alert('Congratulations! ' + wonPlayer + ' won!');
            }
        }
    
          function createBoard() {
            cards.forEach((card, index) => {
              const cardElement = document.createElement('div');
              cardElement.classList.add('card');
              cardElement.dataset.index = index;
              cardElement.dataset.clicked = false;
              cardElement.textContent = '?';
              cardElement.addEventListener('click', flipCard);
              memoryBoard.appendChild(cardElement);
            });
          }

          function addToHistory(card) {
            const index = card.dataset.index;
            const newCard = { index, letter: cards[index] };
            movesHistory.push(newCard);

            // Delete the oldest move
            if (movesHistory.length > 10) 
                movesHistory.shift();

            // Add card to ever found
            if (!allFound.some(move => move.index === index)) 
                allFound.push(newCard);
          }
    
          function flipCard() {
            const selectedCard = this;
            const index = selectedCard.dataset.index;
            const clicked = selectedCard.dataset.clicked;

            if (clicked == true)
                return;

            addToHistory(selectedCard);

            if (flippedIndexes.length < 2 && !flippedIndexes.includes(index)) {
              flippedCards.push(cards[index]);
              flippedIndexes.push(index);
    
              selectedCard.textContent = cards[index];
              selectedCard.classList.add(currentPlayer);
    
              if (flippedIndexes.length === 2) {
                setTimeout(checkMatch, 700);
              }
            }
          }
    
          function checkMatch() {
            const [index1, index2] = flippedIndexes;
            const [card1, card2] = flippedCards;

            let gotPoint = false;
    
            if (card1 === card2) {
              flippedIndexes.forEach(index => {
                const matchedCard = document.querySelector(`[data-index="${index}"]`);
                matchedCard.dataset.clicked = true;
              });
              gotPoint = true;
              updatePlayerPoints();
            } else {
              flippedIndexes.forEach(index => {
                const flippedCard = document.querySelector(`[data-index="${index}"]`);
                flippedCard.textContent = '?';

                if (flippedCard.classList.contains("p1"))
                    flippedCard.classList.remove("p1");

                if (flippedCard.classList.contains("p2"))
                    flippedCard.classList.remove("p2");

              });
            }
    
            flippedCards = [];
            flippedIndexes = [];

            if (!gotPoint) {
                if (currentPlayer == "p1") currentPlayer = "p2";
                else currentPlayer = "p1";
                updateCurrentPlayer();
            }

            if (this.gameMode == 'single' && currentPlayer == 'p2')
                makeBotMove();
            
            endGame();
          }

          function click2RandomElements() {
            const unclickedCards = document.querySelectorAll('.card[data-clicked="false"]');
            const randomIndex1 = Math.floor(Math.random() * unclickedCards.length);
            let randomIndex2 = Math.floor(Math.random() * unclickedCards.length);

            // Zapewnij, aby randomIndex2 był inny niż randomIndex1
            while (randomIndex2 === randomIndex1) {
                randomIndex2 = Math.floor(Math.random() * unclickedCards.length);
            }

            // Kliknij wybrane karty
            unclickedCards[randomIndex1].click();
            unclickedCards[randomIndex2].click();
          }

          function makeBotMove() {
            console.log(this.gameDifficulty);
            if (this.gameDifficulty == 1) {
                click2RandomElements();
                return;
            }

            if (this.gameDifficulty == 2) {
                const unclickedCards = document.querySelectorAll('.card[data-clicked="false"]');

  const unclickedCardsArray = Array.from(unclickedCards);

  // Sprawdź historię ruchów
  for (let i = movesHistory.length - 1; i >= 0; i--) {
    const move = movesHistory[i];
    const matchingCard = unclickedCardsArray.find(card => cards[parseInt(card.dataset.index)] === move.letter);

    if (matchingCard) {
      // Znaleziono pasującą parę w historii, kliknij obie karty
      unclickedCardsArray[randomIndex1].click();
      matchingCard.click();
      return;
    }
  }

                click2RandomElements();
            }
          }
    
      </script>
      
</html>
